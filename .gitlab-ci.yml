image: ghcr.io/siemens/kas/kas:latest-release

stages:
  - prep
  - build

# Common job fragment to get a worker ready
.setup:
  stage: build
  interruptible: true
  variables:
    KAS_WORK_DIR: $CI_PROJECT_DIR/work
    KAS_REPO_REF_DIR: $CI_BUILDS_DIR/persist/repos
    SSTATE_DIR: $CI_BUILDS_DIR/persist/sstate
    DL_DIR: $CI_BUILDS_DIR/persist/downloads
    BB_LOGCONFIG: $CI_PROJECT_DIR/ci/logging.yml
    TOOLCHAIN_DIR: $CI_BUILDS_DIR/persist/toolchains
    IMAGE_DIR: $CI_PROJECT_DIR/work/build/tmp/deploy/images
    TOOLCHAIN_LINK_DIR: $CI_PROJECT_DIR/work/build/toolchains
  before_script:
    - echo KAS_WORK_DIR = $KAS_WORK_DIR
    - echo SSTATE_DIR = $SSTATE_DIR
    - echo DL_DIR = $DL_DIR
    - rm -rf $KAS_WORK_DIR
    - mkdir --verbose --parents $KAS_WORK_DIR $KAS_REPO_REF_DIR $SSTATE_DIR $DL_DIR $TOOLCHAIN_DIR $TOOLCHAIN_LINK_DIR

#
# Prep stage, update repositories once
#
update-repos:
  extends: .setup
  stage: prep
  script:
    - flock --verbose --timeout 60 $KAS_REPO_REF_DIR ./ci/update-repos

# Generate the downstream pipelines
linux-machine-config:
  stage: prep
  variables:
    TEST_LEVEL: 4
  script:
    - echo TEST_LEVEL = $TEST_LEVEL
    - for i in $(grep -L "trusted-firmware-m" ci/*.yml | xargs -i grep '^machine' {} | cut -d ':' -f 2 | sort -u | grep -v unset); do ./ci/generate-ci-config $i $TEST_LEVEL >> linux-machine-config.yml; done
    - cat linux-machine-config.yml
  artifacts:
    paths:
      - linux-machine-config.yml
    expire_in: 1 day

rtos-machine-config:
  stage: prep
  script:
    # avoid combinations that do not work on Zephyr or TF-M
    - for i in $(grep -l "trusted-firmware-m" ci/*.yml | xargs -i grep '^machine' {} | cut -d ':' -f 2 | sort -u | grep -v unset); do ./ci/generate-ci-config $i 1 >> rtos-machine-config.yml; done
    - cat rtos-machine-config.yml
  artifacts:
    paths:
      - rtos-machine-config.yml
    expire_in: 1 day


#
# Build stage, the actual build jobs
#

linux-machine-pipeline:
  stage: build
  needs:
    - job: update-repos
      job: linux-machine-config
  trigger:
    strategy: depend
    include:
      - artifact: linux-machine-config.yml
        job: linux-machine-config

rtos-machine-pipeline:
  stage: build
  needs:
    - job: update-repos
      job: rtos-machine-config
  trigger:
    strategy: depend
    include:
      - artifact: rtos-machine-config.yml
        job: rtos-machine-config

selftest:
  extends: .setup
  needs:
    - job: update-repos
  script:
    - sudo apt-get update && sudo apt-get install --yes telnet python3-subunit
    - KASFILES=./ci/qemuarm64.yml:./ci/selftest.yml
    - kas shell --update --force-checkout $KASFILES -c 'oe-selftest --num-processes 1 --run-tests runfvp'

# Validate layers are Yocto Project Compatible
check-layers:
  extends: .setup
  needs:
    - job: update-repos
  script:
    - kas shell --update --force-checkout ci/base.yml:ci/meta-openembedded.yml --command \
      "yocto-check-layer-wrapper $CI_PROJECT_DIR/$LAYER --dependency $CI_PROJECT_DIR/meta-* $KAS_WORK_DIR/meta-openembedded/meta-oe --no-auto-dependency"
  parallel:
    matrix:
      - LAYER: [meta-arm, meta-arm-bsp, meta-arm-toolchain, meta-gem5, meta-atp]

# What percentage of machines in the layer do we build
machine-coverage:
  stage: prep
  interruptible: true
  script:
    - ./ci/check-machine-coverage
  coverage: '/Coverage: \d+/'

pending-updates:
  extends: .setup
  artifacts:
    paths:
      - update-report
  script:
    - rm -fr update-report
    # This configuration has all of the layers we need enabled
    - kas shell ci/gem5-arm64.yml --command \
      "$CI_PROJECT_DIR/scripts/machine-summary.py -t report -o $CI_PROJECT_DIR/update-report $($CI_PROJECT_DIR/ci/listmachines.py meta-arm meta-arm-bsp meta-gem5)"
  # Do this on x86 whilst the compilers are x86-only
  tags:
    - x86_64

metrics:
  extends: .setup
  artifacts:
    reports:
      metrics: metrics.txt
  script:
    - kas shell --update --force-checkout ci/base.yml --command \
      "$CI_PROJECT_DIR/ci/patchreview $CI_PROJECT_DIR/meta-* --verbose --metrics $CI_PROJECT_DIR/metrics.txt"
