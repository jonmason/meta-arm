# Configuration for Arm Neoverse v3 Reference Design development board

#@TYPE: Machine
#@NAME: RD V3
#@DESCRIPTION: Machine configuration for RD V3

#require conf/machine/include/arm/armv8-4a/tune-neoversev3.inc
require conf/machine/include/arm/arch-armv9a.inc

#EXTRA_IMAGEDEPENDS += "virtual/control-processor-firmware"
EXTRA_IMAGEDEPENDS += "trusted-firmware-a"
EXTRA_IMAGEDEPENDS += "trusted-firmware-m"

KERNEL_IMAGETYPE ?= "Image"
PREFERRED_PROVIDER_virtual/kernel:forcevariable = "linux-yocto"
SERIAL_CONSOLES = "115200;ttyAMA0 115200;ttyAMA1"

EFI_PROVIDER ?= "${@bb.utils.contains("DISTRO_FEATURES", "systemd", "systemd-boot", "grub-efi", d)}"
MACHINE_FEATURES += "efi"

IMAGE_FSTYPES:forcevariable = "cpio.gz wic"
IMAGE_NAME_SUFFIX = ""
IMAGE_CLASSES += "fvpboot"

WKS_FILE ?= "efi-disk.wks.in"
WKS_FILE_DEPENDS:append = " ${EXTRA_IMAGEDEPENDS}"

# testimage config
TEST_TARGET = "OEFVPTarget"
#TEST_TARGET_IP = "127.0.0.1:2222"
TEST_SUITES = "fvp_boot"
#DEFAULT_TEST_SUITES:append = " fvp_boot fvp_devices"
#TEST_FVP_DEVICES ?= "rtc watchdog networking virtiorng cpu_hotplug"

# FVP Config
FVP_PROVIDER ?= "fvp-rdv3-native"
FVP_EXE ?= "FVP_RD_V3"

# TF-M Stuff
FVP_CONFIG[css.sysctrl.rse.rom.raw_image] ?= "tf_m_rom.bin"
FVP_DATA ?= "css.sysctrl.rse.cpu=tf_m_flash.bin@0xB0000000 \
             css.sysctrl.rse.cpu=tf_m_vm0_0.bin@0x31000400 \
             css.sysctrl.rse.cpu=tf_m_vm1_0.bin@0x31080000"

FVP_CONFIG[ros.board.flashloader0.fname] ?= "fip-rdv3.bin"
# ros.board.flashloader1.fname=/builder/rdv3/model-scripts/rdinfra/platforms/rdv3/nor1_flash.img
# ros.board.flashloader1.fnameWrite=/builder/rdv3/model-scripts/rdinfra/platforms/rdv3/nor1_flash.img
# ros.board.flashloader2.fname=/builder/rdv3/model-scripts/rdinfra/platforms/rdv3/nor2_flash.img
# ros.board.flashloader2.fnameWrite=/builder/rdv3/model-scripts/rdinfra/platforms/rdv3/nor2_flash.img 	-I -R

FVP_CONFIG[css.sysctrl.rse.DISABLE_GATING] ?= "true"
FVP_CONFIG[css.sysctrl.HAS_RSE_CPU_PRIVATE_REGION] ?= "1"
FVP_CONFIG[css.sysctrl.mcp.pl011_uart_mcp.shutdown_tag] ?= "'shutting'"
FVP_CONFIG[pcie_group_0.pcie4.hierarchy_file_name] ?= "<default>"
FVP_CONFIG[pcie_group_0.pcie4.pcie_rc.ahci0.endpoint.ats_supported] ?= "true"
FVP_CONFIG[pcie_group_1.pcie4.hierarchy_file_name] ?= "example_pcie_hierarchy_1.json"
FVP_CONFIG[pcie_group_2.pcie4.hierarchy_file_name] ?= "example_pcie_hierarchy_2.json"
FVP_CONFIG[pcie_group_3.pcie4.hierarchy_file_name] ?= "example_pcie_hierarchy_3.json"
FVP_CONFIG[css.sysctrl.rse.intchecker.ICBC_RESET_VALUE] ?= "0x0000011B"

FVP_CONFIG[css.sysctrl.rse.CMU4_NUM_DB_CH] ?= "5"
FVP_CONFIG[css.sysctrl.scp.ap2scp_mhu_s.NUM_DB_CH] ?= "6"
FVP_CONFIG[css.sysctrl.scp.scp2ap_mhu_s.NUM_DB_CH] ?= "6"
FVP_CONFIG[css.sysctrl.scp.ap2scp_mhu_s.NUM_DB_CH] ?= "6"
FVP_CONFIG[css.sysctrl.scp.scp2ap_mhu_s.NUM_DB_CH] ?= "6"
FVP_CONFIG[css.sysctrl.rse.CMU0_NUM_DB_CH] ?= "16"

FVP_CONFIG[css.gic_distributor.ITS-device-bits] ?= "20"

FVP_CONSOLES[default] = "terminal_ns_uart0"
# Could be css.sysctrl.mcp.pl011_uart_mcp
FVP_TERMINALS[css.sysctrl.mcp.terminal_uart_mcp] ?= "MCP"
# Could be css.sysctrl.scp.pl011_uart_scp
FVP_TERMINALS[css.sysctrl.scp.terminal_uart_scp] ?= "SCP"
# Could be css.sysctrl.scp.pl011_uart_lcp
FVP_TERMINALS[css.sysctrl.scp.terminal_uart_lcp] ?= "LCP"
# Could be css.sysctrl.rse_uart
FVP_TERMINALS[css.sysctrl.terminal_rse_uart] ?= "TF-A"
# Could be css.ap_periph.sec_uart
FVP_TERMINALS[css.ap_periph.terminal_sec_uart] ?= "EDK2"
# Could be css.ap_periph.ns_uart0
FVP_TERMINALS[css.ap_periph.terminal_ns_uart0] ?= "Linux"
# Could be css.ap_periph.ns_uart1
FVP_TERMINALS[css.ap_periph.terminal_ns_uart1] ?= "RMM"
FVP_TERMINALS[ros.soc.terminal_s0] ?= ""
FVP_TERMINALS[ros.soc.terminal_s1] ?= ""
FVP_TERMINALS[ros.board.terminal_0] ?= ""
FVP_TERMINALS[ros.board.terminal_1] ?= ""
#5011 TelnetTerminal - No Output
#FVP_TERMINALS[] ?= ""
#5012 TelnetTerminal - No Output
#FVP_TERMINALS[] ?= ""


# Virtio configuration
#FVP_CONFIG[ros.board.virtio_net.enabled] ?= "1"
#FVP_CONFIG[ros.board.virtio_net.hostbridge.userNetworking] ?= "1"
#FVP_CONFIG[ros.board.virtio_net.hostbridge.userNetPorts] = "2222=22"
FVP_CONFIG[ros.board.virtioblockdevice.image_path] ?= "${IMAGE_NAME}.wic"
